// TaxStud - Hybrid Taxonomy Management System
import { LineEdit, Button, StandardListView, GridBox, HorizontalBox, VerticalBox, ScrollView } from "std-widgets.slint";

enum Theme { light, dark }
export enum StatusLevel { none, success, info, warning, danger }

export struct StatusMessage {
    text: string,
    level: StatusLevel,
}

export struct FacetInput {
    name: string,
    value: string,
}

export struct TreeNode {
    label: string,
    indent-level: int,
}

export component MainWindow inherits Window {

    // Theme
    in-out property <Theme> theme: Theme.dark;

    // Window properties
    in property <string> window-title <=> root.title;
    in property <StatusMessage> status: { text: "", level: StatusLevel.none };
    in property <string> taxonomy-description;
    in property <string> hierarchy-root;
    in property <[TreeNode]> hierarchy-tree: [];
    in property <[StandardListViewItem]> items-list;
    in property <string> facet-dimensions-text;

    // Selected item properties
    in-out property <int> selected-item-index: -1;
    in property <string> selected-item-name;
    in property <string> selected-item-path;
    in property <string> selected-item-facets;

    // Filter properties
    in-out property <string> genus-filter-text: "";
    in-out property <string> facet-filter-text: "";
    in property <string> active-filters-text: "";

    // Edit mode properties
    in-out property <bool> is-editing: false;
    in-out property <string> edit-item-name: "";
    in-out property <string> edit-item-path: "";
    in property <[FacetInput]> edit-facet-inputs: [];
    in property <string> validation-error: "";

    // Create mode properties
    in-out property <bool> is-creating: false;
    in-out property <string> new-item-name: "";
    in-out property <string> new-item-path: "";
    in property <[FacetInput]> create-facet-inputs: [];

    // Dialog properties
    in-out property <bool> show-confirmation-dialog: false;
    in property <string> confirmation-message: "";
    in-out property <bool> show-error-dialog: false;
    in property <string> error-title: "";
    in property <string> error-message: "";
    in property <string> error-details: "";
    in-out property <bool> show-simple-confirmation: false;
    in property <string> simple-confirmation-title: "";
    in property <string> simple-confirmation-message: "";
    in property <string> simple-confirmation-button: "OK";

    // File operation callbacks
    callback file-open();
    callback file-save();
    callback file-save-as();
    callback file-new();
    callback file-revert();

    // Item selection callback
    callback item-selected(int);

    // Sort callback
    callback sort-by-name();

    // Filter callbacks
    callback apply-filters();
    callback clear-filters();

    // Edit callbacks
    callback start-edit();
    callback save-edit();
    callback cancel-edit();

    // Create/Delete callbacks
    callback start-create-item();
    callback save-new-item();
    callback cancel-create-item();
    callback delete-item();

    // Theme callback
    callback toggle-theme();

    // About callback
    callback about();

    // Facet value update callbacks
    callback update-edit-facet(int, string);
    callback update-create-facet(int, string);

    // Dialog response callbacks
    callback confirmation-save();
    callback confirmation-dont-save();
    callback confirmation-cancel();
    callback error-dialog-close();
    callback simple-confirmation-ok();
    callback simple-confirmation-cancel();

    // Theme colors (will be set by states)
    property <color> bg-primary: #fafafa;
    property <color> bg-secondary: #f5f5f5;
    property <color> bg-header: #e8e8e8;
    property <color> bg-center: #ffffff;
    property <color> bg-statusbar: #f0f0f0;
    property <color> border-color: #ddd;
    property <color> text-primary: #000;
    property <color> text-secondary: #666;
    property <color> text-tertiary: #999;
    property <color> text-danger: #d00;

    // Semantic colors
    property <color> text-success: #0f5132;
    property <color> text-info: #055160;
    property <color> text-warning: #664d03;
    property <color> bg-success: #d1e7dd;
    property <color> bg-info: #cff4fc;
    property <color> bg-warning: #fff3cd;
    property <color> bg-danger: #f8d7da;

    min-width: 1000px;
    min-height: 700px;

    // Padding
    property <length> p-window: 3px;
    property <length> p-header: 3px;
    property <length> p-pane: 0px;

    // Height
    property <length> h-header: 30px;

    // Spacing
    property <length> sp-header: 8px;
    property <length> sp-content: 8px;

    // Dark theme state
    states [
        dark when root.theme == Theme.dark: {
            bg-primary: #2a2a2a;
            bg-secondary: #1e1e1e;
            bg-header: #333333;
            bg-center: #252525;
            bg-statusbar: #1a1a1a;
            border-color: #444;
            text-primary: #ffffff;
            text-secondary: #cccccc;
            text-tertiary: #888888;
            text-danger: #ff6b6b;
            text-success: #75b798;
            text-info: #6edff6;
            text-warning: #ffda6a;
            bg-success: #0f5132;
            bg-info: #055160;
            bg-warning: #664d03;
            bg-danger: #842029;
        }
    ]

    MenuBar {
        Menu {
            title: "File";

            MenuItem {
                title: "New";
                activated => { root.file-new(); }
            }

            MenuItem {
                title: "Open...";
                activated => { root.file-open(); }
            }

            MenuItem {
                title: "Revert to Saved";
                activated => { root.file-revert(); }
            }

            MenuItem {
                title: "Save";
                activated => { root.file-save(); }
            }

            MenuItem {
                title: "Save As...";
                activated => { root.file-save-as(); }
            }
        }

        Menu {
            title: "View";

            MenuItem {
                title: root.theme == Theme.light ? "Dark Theme" : "Light Theme";
                activated => { root.toggle-theme(); }
            }
        }

        Menu {
            title: "Help";

            MenuItem {
                title: "About";
                activated => { root.about(); }
            }
        }
    }

    VerticalBox {
        padding: root.p-window;

        // Toolbar
        HorizontalBox {
            height: 40px;
            padding: root.p-pane;
            spacing: root.sp-content;

            Text {
                text: root.taxonomy-description != "" ? root.taxonomy-description : "No taxonomy loaded";
                vertical-alignment: center;
                color: root.text-secondary;
                font-size: 12px;
            }
        }

        // Main 3-panel layout
        HorizontalBox {
            spacing: 0;
            padding: root.p-pane;

            // Left panel - Hierarchy Tree
            Rectangle {
                horizontal-stretch: 1;
                background: root.bg-primary;
                border-width: 1px;
                border-color: root.border-color;

                VerticalBox {

                // Panel header
                Rectangle {
                    height: root.h-header;
                    background: root.bg-header;

                    HorizontalBox {
                        padding: root.p-header;

                        Text {
                            text: "Classification";
                            font-weight: 700;
                            vertical-alignment: center;
                            color: root.text-primary;
                        }
                    }
                }

                // Panel content
                ScrollView {
                    vertical-stretch: 1;

                    VerticalBox {
                        padding: root.sp-content;

                        if root.hierarchy-root != "" : VerticalBox {
                            spacing: 2px;

                            // Root node
                            HorizontalBox {
                                padding-left: 4px;
                                padding-top: 4px;
                                padding-bottom: 4px;

                                Text {
                                    text: "⬤ " + root.hierarchy-root;
                                    font-weight: 700;
                                    color: root.text-primary;
                                    font-size: 12px;
                                }
                            }

                            // Tree nodes
                            for node in root.hierarchy-tree : HorizontalBox {
                                padding-left: 4px + (node.indent-level * 16px);
                                padding-top: 2px;
                                padding-bottom: 2px;

                                Text {
                                    text: "├─ " + node.label;
                                    color: root.text-secondary;
                                    font-size: 11px;
                                }
                            }
                        }

                        if root.hierarchy-root == "" : Text {
                            text: "No taxonomy loaded";
                            color: root.text-tertiary;
                        }
                    }
                }
                }
            }

            // Center panel - Items List
            Rectangle {
                horizontal-stretch: 1;
                background: root.bg-center;
                border-width: 1px;
                border-color: root.border-color;

                VerticalBox {

                // Panel header
                Rectangle {
                    height: root.h-header;
                    background: root.bg-header;

                    HorizontalBox {
                        padding: root.p-header;
                        spacing: root.sp-header;

                        Text {
                            text: "Items (" + root.items-list.length + ")";
                            font-weight: 700;
                            vertical-alignment: center;
                            color: root.text-primary;
                        }

                        Rectangle {
                            horizontal-stretch: 1;
                        }

                        if root.taxonomy-description != "" : Button {
                            text: "New Item";
                            clicked => { root.start-create-item(); }
                        }

                        Button {
                            text: "Sort by Name";
                            clicked => { root.sort-by-name(); }
                        }
                    }
                }

                // Panel content
                VerticalBox {
                    if root.items-list.length > 0 : items-view := StandardListView {
                        model: root.items-list;
                        current-item <=> root.selected-item-index;
                        current-item-changed(index) => {
                            root.item-selected(index);
                        }
                    }

                    if root.items-list.length == 0 : VerticalBox {
                        alignment: center;

                        Text {
                            text: root.taxonomy-description != "" ? "No items in taxonomy" : "No taxonomy loaded";
                            color: root.text-tertiary;
                            horizontal-alignment: center;
                        }
                    }
                }
                }
            }

            // Right panel - Details/Edit
            Rectangle {
                horizontal-stretch: 1;
                background: root.bg-primary;
                border-width: 1px;
                border-color: root.border-color;

                VerticalBox {

                // Panel header
                Rectangle {
                    height: root.h-header;
                    background: root.bg-header;

                    HorizontalBox {
                        padding: root.p-header;
                        spacing: root.sp-header;

                        Text {
                            text: "Details";
                            font-weight: 700;
                            vertical-alignment: center;
                            color: root.text-primary;
                        }

                        Rectangle {
                            horizontal-stretch: 1;
                        }

                        if root.selected-item-name != "" && !root.is-editing && !root.is-creating : Button {
                            text: "Edit";
                            clicked => { root.start-edit(); }
                        }

                        if root.selected-item-name != "" && !root.is-editing && !root.is-creating : Button {
                            text: "Delete";
                            clicked => { root.delete-item(); }
                        }

                        if root.is-editing : Button {
                            text: "Save";
                            clicked => { root.save-edit(); }
                        }

                        if root.is-editing : Button {
                            text: "Cancel";
                            clicked => { root.cancel-edit(); }
                        }

                        if root.is-creating : Button {
                            text: "Create";
                            clicked => { root.save-new-item(); }
                        }

                        if root.is-creating : Button {
                            text: "Cancel";
                            clicked => { root.cancel-create-item(); }
                        }
                    }
                }

                // Panel content
                ScrollView {
                    VerticalBox {
                        padding: 12px;
                        spacing: root.sp-content;

                        if root.selected-item-name != "" && !root.is-editing : VerticalBox {
                            spacing: 12px;

                            // Item name (read-only)
                            VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Name:";
                                    font-size: 10px;
                                    color: root.text-secondary;
                                }

                                Text {
                                    text: root.selected-item-name;
                                    font-weight: 700;
                                    font-size: 14px;
                                    color: root.text-primary;
                                }
                            }

                            // Item path (read-only)
                            if root.selected-item-path != "" : VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Classification Path:";
                                    font-size: 10px;
                                    color: root.text-secondary;
                                }

                                Text {
                                    text: root.selected-item-path;
                                    wrap: word-wrap;
                                    color: root.text-primary;
                                }
                            }

                            Rectangle {
                                height: 1px;
                                background: root.border-color;
                            }

                            // Facets (read-only)
                            if root.selected-item-facets != "" : VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Facets:";
                                    font-size: 10px;
                                    color: root.text-secondary;
                                }

                                Text {
                                    text: root.selected-item-facets;
                                    wrap: word-wrap;
                                    color: root.text-primary;
                                }
                            }
                        }

                        if root.is-editing : VerticalBox {
                            spacing: 12px;

                            // Validation error
                            if root.validation-error != "" : VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: root.validation-error;
                                    color: root.text-danger;
                                    font-weight: 700;
                                    wrap: word-wrap;
                                }

                                Rectangle {
                                    height: 1px;
                                    background: root.border-color;
                                }
                            }

                            // Item name (editable)
                            VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Name:";
                                    font-size: 10px;
                                    color: root.text-secondary;
                                }

                                LineEdit {
                                    text <=> root.edit-item-name;
                                }
                            }

                            // Item path (editable - comma-separated)
                            VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Classification Path (comma-separated):";
                                    font-size: 10px;
                                    color: root.text-secondary;
                                }

                                LineEdit {
                                    text <=> root.edit-item-path;
                                    placeholder-text: "e.g., Beverages, Hot Beverages, Coffee";
                                }
                            }

                            Rectangle {
                                height: 1px;
                                background: root.border-color;
                            }

                            // Facets (editable - individual inputs)
                            if root.edit-facet-inputs.length > 0 : VerticalBox {
                                spacing: 8px;

                                Text {
                                    text: "Facets:";
                                    font-size: 10px;
                                    color: root.text-secondary;
                                }

                                for facet-input[idx] in root.edit-facet-inputs : HorizontalBox {
                                    spacing: 8px;
                                    alignment: start;

                                    Text {
                                        text: facet-input.name + ":";
                                        vertical-alignment: center;
                                        color: root.text-primary;
                                        font-size: 11px;
                                        min-width: 120px;
                                    }

                                    LineEdit {
                                        text: facet-input.value;
                                        horizontal-stretch: 1;
                                        edited => {
                                            root.update-edit-facet(idx, self.text);
                                        }
                                    }
                                }

                                Rectangle {
                                    height: 1px;
                                    background: root.border-color;
                                }
                            }

                            Text {
                                text: "Note: Changes require validation before saving";
                                font-size: 11px;
                                color: root.text-tertiary;
                                wrap: word-wrap;
                            }
                        }

                        if root.is-creating : VerticalBox {
                            spacing: 12px;

                            // Validation error
                            if root.validation-error != "" : VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: root.validation-error;
                                    color: root.text-danger;
                                    font-weight: 700;
                                    wrap: word-wrap;
                                }

                                Rectangle {
                                    height: 1px;
                                    background: root.border-color;
                                }
                            }

                            Text {
                                text: "Create New Item";
                                font-weight: 700;
                                font-size: 14px;
                                color: root.text-primary;
                            }

                            Rectangle {
                                height: 1px;
                                background: root.border-color;
                            }

                            // Item name
                            VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Name:";
                                    font-size: 10px;
                                    color: root.text-secondary;
                                }

                                LineEdit {
                                    text <=> root.new-item-name;
                                    placeholder-text: "Enter item name";
                                }
                            }

                            // Item path
                            VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Classification Path (comma-separated):";
                                    font-size: 10px;
                                    color: root.text-secondary;
                                }

                                LineEdit {
                                    text <=> root.new-item-path;
                                    placeholder-text: "e.g., Beverages, Hot Beverages, Coffee";
                                }
                            }

                            Rectangle {
                                height: 1px;
                                background: root.border-color;
                            }

                            // Facets (individual inputs)
                            if root.create-facet-inputs.length > 0 : VerticalBox {
                                spacing: 8px;

                                Text {
                                    text: "Facets:";
                                    font-size: 10px;
                                    color: root.text-secondary;
                                }

                                for facet-input[idx] in root.create-facet-inputs : HorizontalBox {
                                    spacing: 8px;
                                    alignment: start;

                                    Text {
                                        text: facet-input.name + ":";
                                        vertical-alignment: center;
                                        color: root.text-primary;
                                        font-size: 11px;
                                        min-width: 120px;
                                    }

                                    LineEdit {
                                        text: facet-input.value;
                                        horizontal-stretch: 1;
                                        edited => {
                                            root.update-create-facet(idx, self.text);
                                        }
                                    }
                                }
                            }
                        }

                        if root.selected-item-name == "" && root.taxonomy-description != "" && !root.is-creating : Text {
                            text: "Select an item to view details";
                            color: root.text-tertiary;
                        }

                        if root.taxonomy-description == "" : Text {
                            text: "No taxonomy loaded";
                            color: root.text-tertiary;
                        }
                    }
                }
                }
            }
        }

        // Bottom panel - Facet Filters
        Rectangle {
            height: 250px;
            background: root.bg-secondary;
            border-width: 1px;
            border-color: root.border-color;

            VerticalBox {
                // Panel header
                Rectangle {
                    height: root.h-header;
                    background: root.bg-header;

                    HorizontalBox {
                        padding: root.p-header;
                        spacing: root.sp-header;

                        Text {
                            text: "Filters";
                            font-weight: 700;
                            vertical-alignment: center;
                            color: root.text-primary;
                        }

                        Rectangle {
                            horizontal-stretch: 1;
                        }

                        Button {
                            text: "Apply Filters";
                            clicked => { root.apply-filters(); }
                        }

                        Button {
                            text: "Clear Filters";
                            clicked => { root.clear-filters(); }
                        }
                    }
                }

                // Panel content
                ScrollView {
                    VerticalBox {
                        padding: 12px;
                        spacing: 12px;

                        HorizontalBox {
                            // Genus filter
                            if root.taxonomy-description != "" : VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Filter by Genus (comma-separated):";
                                    font-size: 11px;
                                    font-weight: 600;
                                    color: root.text-primary;
                                }

                                LineEdit {
                                    text <=> root.genus-filter-text;
                                    placeholder-text: "e.g., Coffee, Tea";
                                }
                            }

                            // Facet filter
                            if root.taxonomy-description != "" : VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Filter by Facets (comma-separated, format: name=value):";
                                    font-size: 11px;
                                    font-weight: 600;
                                    color: root.text-primary;
                                }

                                LineEdit {
                                    text <=> root.facet-filter-text;
                                    placeholder-text: "e.g., temperature=hot, caffeine_content=high";
                                }
                            }
                        
                        }


                        // Active filters display
                        if root.active-filters-text != "" : VerticalBox {
                            spacing: 4px;

                            Text {
                                text: "Active Filters:";
                                font-size: 11px;
                                font-weight: 600;
                                color: root.text-primary;
                            }

                            Text {
                                text: root.active-filters-text;
                                color: root.text-secondary;
                                wrap: word-wrap;
                            }
                        }

                        // Available facets info
                        if root.facet-dimensions-text != "" : VerticalBox {
                            spacing: 4px;

                            Text {
                                text: "Available Facets:";
                                font-size: 11px;
                                font-weight: 600;
                                color: root.text-primary;
                            }

                            Text {
                                text: root.facet-dimensions-text;
                                color: root.text-tertiary;
                                font-size: 10px;
                                wrap: word-wrap;
                            }
                        }
                    }
                }
            }
        }

        // Status bar
        Rectangle {
            height: 60px;
            background: root.status.level == StatusLevel.success ? root.bg-success :
                       root.status.level == StatusLevel.info ? root.bg-info :
                       root.status.level == StatusLevel.warning ? root.bg-warning :
                       root.status.level == StatusLevel.danger ? root.bg-danger :
                       root.bg-statusbar;

            HorizontalBox {
                padding: root.sp-content;

                Text {
                    text: root.status.text;
                    vertical-alignment: center;
                    color: root.status.level == StatusLevel.success ? root.text-success :
                           root.status.level == StatusLevel.info ? root.text-info :
                           root.status.level == StatusLevel.warning ? root.text-warning :
                           root.status.level == StatusLevel.danger ? root.text-danger :
                           root.text-primary;
                    font-weight: root.status.level != StatusLevel.none ? 700 : 400;
                }
            }
        }
    }

    // Confirmation Dialog Overlay
    if root.show-confirmation-dialog : Rectangle {
        width: 100%;
        height: 100%;
        background: #00000080;

        Rectangle {
            width: 500px;
            height: 200px;
            background: root.bg-primary;
            border-width: 2px;
            border-color: root.border-color;
            border-radius: 8px;
            drop-shadow-blur: 16px;
            drop-shadow-color: #00000040;

            VerticalBox {
                padding: 24px;
                spacing: 20px;

                // Dialog title
                Text {
                    text: "Unsaved Changes";
                    font-size: 16px;
                    font-weight: 700;
                    color: root.text-primary;
                }

                // Dialog message
                Text {
                    text: root.confirmation-message;
                    wrap: word-wrap;
                    color: root.text-primary;
                    vertical-stretch: 1;
                }

                // Dialog buttons
                HorizontalBox {
                    spacing: 12px;
                    alignment: end;

                    Button {
                        text: "Save";
                        primary: true;
                        clicked => {
                            root.confirmation-save();
                        }
                    }

                    Button {
                        text: "Don't Save";
                        clicked => {
                            root.confirmation-dont-save();
                        }
                    }

                    Button {
                        text: "Cancel";
                        clicked => {
                            root.confirmation-cancel();
                        }
                    }
                }
            }
        }
    }

    // Error Dialog Overlay
    if root.show-error-dialog : Rectangle {
        width: 100%;
        height: 100%;
        background: #00000080;

        Rectangle {
            width: 600px;
            max-height: 500px;
            background: root.bg-primary;
            border-width: 2px;
            border-color: root.border-color;
            border-radius: 8px;
            drop-shadow-blur: 16px;
            drop-shadow-color: #00000040;

            VerticalBox {
                padding: 24px;
                spacing: 16px;

                // Dialog title
                Text {
                    text: root.error-title;
                    font-size: 16px;
                    font-weight: 700;
                    color: root.text-danger;
                }

                // Separator
                Rectangle {
                    height: 1px;
                    background: root.border-color;
                }

                // Dialog message
                ScrollView {
                    vertical-stretch: 1;

                    VerticalBox {
                        spacing: 12px;

                        if root.error-message != "" : Text {
                            text: root.error-message;
                            wrap: word-wrap;
                            color: root.text-primary;
                        }

                        if root.error-details != "" : VerticalBox {
                            spacing: root.sp-content;

                            Text {
                                text: "Details:";
                                font-weight: 700;
                                font-size: 12px;
                                color: root.text-secondary;
                            }

                            Text {
                                text: root.error-details;
                                wrap: word-wrap;
                                color: root.text-secondary;
                                font-family: "monospace";
                                font-size: 11px;
                            }
                        }
                    }
                }

                // Dialog buttons
                HorizontalBox {
                    spacing: 12px;
                    alignment: end;

                    Button {
                        text: "OK";
                        primary: true;
                        clicked => {
                            root.error-dialog-close();
                        }
                    }
                }
            }
        }
    }

    // Simple Confirmation Dialog Overlay
    if root.show-simple-confirmation : Rectangle {
        width: 100%;
        height: 100%;
        background: #00000080;

        Rectangle {
            width: 500px;
            height: 200px;
            background: root.bg-primary;
            border-width: 2px;
            border-color: root.border-color;
            border-radius: 8px;
            drop-shadow-blur: 16px;
            drop-shadow-color: #00000040;

            VerticalBox {
                padding: 24px;
                spacing: 20px;

                // Dialog title
                Text {
                    text: root.simple-confirmation-title;
                    font-size: 16px;
                    font-weight: 700;
                    color: root.text-primary;
                }

                // Dialog message
                Text {
                    text: root.simple-confirmation-message;
                    wrap: word-wrap;
                    color: root.text-primary;
                    vertical-stretch: 1;
                }

                // Dialog buttons
                HorizontalBox {
                    spacing: 12px;
                    alignment: end;

                    Button {
                        text: root.simple-confirmation-button;
                        primary: true;
                        clicked => {
                            root.simple-confirmation-ok();
                        }
                    }

                    Button {
                        text: "Cancel";
                        clicked => {
                            root.simple-confirmation-cancel();
                        }
                    }
                }
            }
        }
    }
}
